function auto_node_modules_bin --on-variable PWD \
        --description 'Automatically add $PWD/node_modules/.bin to path'
    if status --is-command-substitution
        return
    end

    # A list of paths to look for
    set -l test_paths (pwd)/node_modules/.bin

    set -l git_root (pwd)"/"(git rev-parse --show-cdup ^ /dev/null)

    if test "$status" -eq 0
        # A git root was found, look for $git_root/node_modules/.bin
        set test_paths $test_paths $git_root/node_modules/.bin
    end

    # A list of the paths in test_paths that are directories
    set -l bin_paths

    # Check if any of $test_paths exist
    for _path in $test_paths
        if test -d $_path
            # Add them to $bin_paths
            set bin_paths $bin_paths $_path
        end
    end

    if test "$bin_paths" = "$__node_modules_bin_paths"
        # No change
        return
    end

    # Clean up before setting new paths
    __remove_node_modules_bin_paths

    set -g __node_modules_bin_paths $bin_paths
    set -gx PATH $__node_modules_bin_paths $PATH
end

# Private function, used to clean up $PATH
function __remove_node_modules_bin_paths
    if contains $__node_modules_bin_path $PATH
        set -l restored_PATH

        for path in $PATH
            if not contains "$path" $__node_modules_bin_paths
                set restored_PATH $restored_PATH $path
            end
        end

        set -gx PATH $restored_PATH
    end
end
